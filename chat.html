<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3 Kilit Tv — Sohbet</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#f7f7fb; margin:0; padding:0; display:flex; flex-direction:column; height:100vh;}
    header{background:#0f172a;color:white;padding:12px 16px}
    main{flex:1;display:flex;flex-direction:column;padding:10px;gap:10px}
    #messages{flex:1;overflow:auto;background:white;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
    .msg{margin-bottom:8px;padding:8px;border-radius:6px;background:#eef2ff;max-width:75%}
    .me{background:#dbeafe;margin-left:auto}
    .meta{font-size:12px;color:#555;margin-bottom:6px}
    form{display:flex;gap:8px}
    input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
    button{padding:10px 14px;border:none;border-radius:8px;background:#2563eb;color:white;cursor:pointer}
    .status{font-size:13px;color:#333}
  </style>
</head>
<body>
  <header>
    <strong>3 Kilit Tv — Sohbet</strong>
    <div class="status" id="status">Bağlanılıyor...</div>
  </header>

  <main>
    <div id="messages"></div>

    <form id="chatForm">
      <input id="msgInput" type="text" placeholder="Mesaj yaz..." autocomplete="off" />
      <button type="submit">Gönder</button>
    </form>
  </main>

  <!-- Firebase CDN (Realtime Database + Auth) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // -----------------------------
    // 1) BURAYA Firebase config'ini yapıştır:
    // Project settings -> General -> SDK snippet -> config
    // -----------------------------
    const firebaseConfig = {
      apiKey: "API_KEY_HERE",
      authDomain: "PROJECT_ID.firebaseapp.com",
      databaseURL: "https://PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "PROJECT_ID",
      storageBucket: "PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    // -----------------------------

    // Başlat
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const messagesEl = document.getElementById('messages');
    const chatForm = document.getElementById('chatForm');
    const msgInput = document.getElementById('msgInput');
    const statusEl = document.getElementById('status');

    let myUserId = null;

    // 1) Anonymous login
    auth.signInAnonymously()
      .then(() => {
        myUserId = auth.currentUser.uid;
        statusEl.textContent = 'Bağlandı — Sohbete katıldınız';
        // Kullanıcı bilgisi ile mesaj dinlemeye başla
        startListening();
      })
      .catch((err) => {
        console.error('Auth hatası:', err);
        statusEl.textContent = 'Bağlanamadı — konsolu kontrol et';
      });

    // 2) Realtime dinleyici: son 200 mesajı dinle
    function startListening() {
      const ref = db.ref('chats/general').limitToLast(200);
      ref.on('child_added', (snapshot) => {
        const m = snapshot.val();
        appendMessage(m);
      });
    }

    // 3) Mesaj ekleme fonksiyonu
    function appendMessage(m) {
      const wrapper = document.createElement('div');
      wrapper.className = 'msg' + (m.uid === myUserId ? ' me' : '');
      const meta = document.createElement('div');
      meta.className = 'meta';
      const time = new Date(m.timestamp);
      const hh = time.getHours().toString().padStart(2,'0');
      const mm = time.getMinutes().toString().padStart(2,'0');
      meta.textContent = (m.name || 'Ziyaretçi') + ' • ' + hh + ':' + mm;

      const text = document.createElement('div');
      text.textContent = m.text || '';

      wrapper.appendChild(meta);
      wrapper.appendChild(text);

      messagesEl.appendChild(wrapper);
      // otomatik kaydır
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // 4) Form submit -> mesaji DB'ye yaz
    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = msgInput.value.trim();
      if (!text) return;
      const payload = {
        uid: myUserId,
        name: 'Ziyaretçi', // istersen burayı kullanıcı adı ile değiştir
        text: text,
        timestamp: Date.now()
      };
      // push ile benzersiz anahtar oluşturup gönder
      db.ref('chats/general').push(payload)
        .then(() => {
          msgInput.value = '';
        })
        .catch(err => {
          console.error('Mesaj gönderme hatası', err);
        });
    });
  </script>
</body>
</html>
